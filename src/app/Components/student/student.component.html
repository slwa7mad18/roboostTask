<app-header></app-header>

<ng-container *transloco="let t">
  <div class="container my-5">
    <form>
      <div class="d-flex">
        <div class="w-100 pe-3">
          <div class="form-floating mb-3">
            <input
              id="students-table-search"
              type="text"
              class="form-control"
              name="searchTerm"
              [(ngModel)]="_studentDatatableService.searchTerm"
              placeholder=""
            />
            <label for="students-table-search">{{ t("student.search") }}</label>
          </div>
        </div>

        <div>
          <button class="btn btn-primary btn-lg mt-1" (click)="open(content)">
            {{ t("student.table.add") }}
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th scope="col" sortable="ID" (sort)="onSort($event)">#</th>
              <th scope="col" sortable="Name" (sort)="onSort($event)">
                {{ t("student.table.name") }}
              </th>
              <th scope="col" sortable="Mobile" (sort)="onSort($event)">
                {{ t("student.table.mobile") }}
              </th>
              <th scope="col" sortable="Email" (sort)="onSort($event)">
                {{ t("student.table.email") }}
              </th>
              <th scope="col" sortable="NationalID" (sort)="onSort($event)">
                {{ t("student.table.nationalId") }}
              </th>
              <th scope="col" sortable="Age" (sort)="onSort($event)">
                {{ t("student.table.age") }}
              </th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            @for (student of students$ | async; track student.ID) {
            <tr>
              <th scope="row">
                <ngb-highlight
                  [result]="student.ID.toString()"
                  [term]="_studentDatatableService.searchTerm"
                />
              </th>
              <td>
                <ngb-highlight
                  [result]="student.Name"
                  [term]="_studentDatatableService.searchTerm"
                />
              </td>
              <td>
                <ngb-highlight
                  [result]="student.Mobile"
                  [term]="_studentDatatableService.searchTerm"
                />
              </td>
              <td>
                <ngb-highlight
                  [result]="student.Email"
                  [term]="_studentDatatableService.searchTerm"
                />
              </td>
              <td>
                <ngb-highlight
                  [result]="student.NationalID"
                  [term]="_studentDatatableService.searchTerm"
                />
              </td>
              <td>
                <ngb-highlight
                  [result]="student.Age.toString()"
                  [term]="_studentDatatableService.searchTerm"
                />
              </td>
              <td class="text-nowrap">
                <button
                  class="btn btn-warning me-2"
                  [routerLink]="['/edit/' + student.ID]"
                >
                  {{ t("student.table.edit") }}
                </button>
                <button
                  class="btn btn-danger"
                  (click)="DeleteField(student.ID)"
                >
                  {{ t("student.table.delete") }}
                </button>
              </td>
            </tr>

            } @empty {
            <tr>
              <td colspan="7" style="text-align: center">
                {{ t("student.table.empty") }}
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-center p-2">
        <ngb-pagination
          [collectionSize]="(total$ | async)!"
          [(page)]="_studentDatatableService.page"
          [pageSize]="_studentDatatableService.pageSize"
        >
        </ngb-pagination>
      </div>
    </form>
  </div>

  <!-- Add New Student -->
  <ng-template #content let-modal>
    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">{{ t("addStudent") }}</h4>
      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="modal.dismiss()"
      ></button>
    </div>

    <div class="modal-body">
      <form [formGroup]="addForm" (ngSubmit)="AddFields()">
        @if (errorMessage!='') {
        <div class="alert alert-danger" role="alert">
          <h4 class="alert-heading">API Error</h4>
          <p>{{ errorMessage }}</p>
        </div>
        }

        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="firstName"
            placeholder="First Name"
            formControlName="firstName"
            [ngClass]="{ 'is-invalid': submitted && f['firstName'].errors }"
          />
          <label for="firstName">{{ t("form.firstName") }}</label>
          @if (submitted && f['firstName'].errors) {
          <div class="text-danger">
            @if (f['firstName'].errors['required']) {
            <small>{{ t("validation.requiredFirstName") }}</small>
            }
          </div>
          }
        </div>

        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="lastName"
            placeholder="Last Name"
            formControlName="lastName"
            [ngClass]="{ 'is-invalid': submitted && f['lastName'].errors }"
          />
          <label for="lastName">{{ t("form.lastName") }}</label>
          @if (submitted && f['lastName'].errors) {
          <div class="text-danger">
            @if (f['lastName'].errors['required']) {
            <small>{{ t("validation.requiredLastName") }}</small>
            }
          </div>
          }
        </div>

        <div class="form-floating mb-3">
          <input
            type="tel"
            class="form-control"
            id="mobile"
            placeholder="Mobile Number"
            formControlName="mobile"
            [ngClass]="{ 'is-invalid': submitted && f['mobile'].errors }"
          />
          <label for="mobile">{{ t("form.mobile") }}</label>
          @if (submitted && f['mobile'].errors) {
          <div class="text-danger">
            @if (f['mobile'].errors['required']) {
            <small>{{ t("validation.requiredMobile") }}</small>
            }
          </div>
          }
        </div>

        <div class="form-floating mb-3">
          <input
            type="email"
            class="form-control"
            id="email"
            placeholder="Email"
            formControlName="email"
            [ngClass]="{ 'is-invalid': submitted && f['email'].errors }"
          />
          <label for="email">{{ t("form.email") }}</label>
          @if (submitted && f['email'].errors) {
          <div class="text-danger">
            @if (f['email'].errors['required']) {
            <small>{{ t("validation.requiredEmail") }}</small>
            } @if (f['email'].errors['email']) {
            <small>{{ t("validation.emailType") }}</small>
            }
          </div>
          }
        </div>

        <div class="form-floating mb-3">
          <input
            type="text"
            class="form-control"
            id="nationalID"
            placeholder="National ID"
            formControlName="nationalID"
            [ngClass]="{
              'is-invalid': submitted && f['nationalID'].errors
            }"
          />
          <label for="nationalID">{{ t("form.nationalId") }}</label>
          @if (submitted && f['nationalID'].errors) {
          <div class="text-danger">
            @if (f['nationalID'].errors['required']) {
            <small>{{ t("validation.requiredNationalId") }}</small>
            }
          </div>
          }
        </div>

        <div class="form-floating mb-3">
          <input
            type="number"
            class="form-control"
            id="age"
            placeholder="Age"
            formControlName="age"
            [ngClass]="{ 'is-invalid': submitted && f['age'].errors }"
          />
          <label for="age">{{ t("form.age") }}</label>
          @if (submitted && f['age'].errors) {
          <div class="text-danger">
            @if (f['age'].errors['required']) {
            <small>{{ t("validation.requiredAge") }}</small>
            }
          </div>
          }
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-primary my-3 w-50 py-3 fs-5">
            {{ t("addStudent") }}
          </button>
        </div>
      </form>
    </div>
  </ng-template>
</ng-container>
